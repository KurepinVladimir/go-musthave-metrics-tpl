# üìä Go Metrics Service

**Go Metrics Service** ‚Äî —ç—Ç–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–µ –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–±–æ—Ä–∞, —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫. –ü—Ä–æ–µ–∫—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ —Å–∏—Å—Ç–µ–º —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –°–µ—Ä–≤–µ—Ä

* –ü—Ä–∏—ë–º –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —Ç–∏–ø–æ–≤ `gauge` –∏ `counter`
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥–∞—á–∏:

  * JSON (`POST /update`, `POST /updates`, `POST /value`)
  * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã URL (`POST /update/:type/:name/:value`, `GET /value/:type/:name`)
* –•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:

  * –í –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
  * –í —Ñ–∞–π–ª–µ (—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö:

  * –ü–æ–¥–ø–∏—Å—å HMAC-SHA256
  * –°–∂–∞—Ç–∏–µ GZIP
* –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (`pprof`)

### –ê–≥–µ–Ω—Ç

* –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏–∑ `runtime.MemStats` –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
* –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å configurable –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ gzip –∏ HMAC-–ø–æ–¥–ø–∏—Å–∏
* –†–∞–±–æ—Ç–∞ –ø–æ HTTPS

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü–∞—Ä–∞–º–µ—Ç—Ä            | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| --------- | ------------------- | -------------------------------- |
| –ê–≥–µ–Ω—Ç     | `--address`         | –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏       |
|           | `--poll-interval`   | –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫            |
|           | `--report-interval` | –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä      |
| –°–µ—Ä–≤–µ—Ä    | `--store-interval`  | –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ –¥–∏—Å–∫ |
|           | `--restore`         | –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞  |
|           | `--key`             | –∫–ª—é—á –¥–ª—è HMAC-–ø–æ–¥–ø–∏—Å–∏            |

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HMAC-–ø–æ–¥–ø–∏—Å–µ–π –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TLS/HTTPS
* –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
git clone https://github.com/KurepinVladimir/go-musthave-metrics-tpl.git
cd go-musthave-metrics-tpl

go run ./cmd/server/     # –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
go run ./cmd/agent/      # –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
```

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (Windows `cmd.exe`)

```cmd
curl -X POST "http://localhost:8080/update/" ^
     -H "Content-Type: application/json" ^
     -d "{\"id\":\"HeapAlloc\",\"type\":\"gauge\",\"value\":12345.67}"

curl -X POST "http://localhost:8080/value/" ^
     -H "Content-Type: application/json" ^
     -d "{\"id\":\"HeapAlloc\",\"type\":\"gauge\"}"
```

## üß± –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

* **Go** (1.21+)
* **Chi** ‚Äî HTTP-—Ä–æ—É—Ç–µ—Ä
* **Zap** ‚Äî –ª–æ–≥–≥–µ—Ä
* **Resty** ‚Äî HTTP-–∫–ª–∏–µ–Ω—Ç
* **pgx** ‚Äî –¥—Ä–∞–π–≤–µ—Ä PostgreSQL (–≤ –±—É–¥—É—â–µ–º)
* **pprof** ‚Äî –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
* **encoding/json**, **gzip**, **HMAC-SHA256**

## üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
cmd/
‚îú‚îÄ‚îÄ agent/       ‚Äî –∞–≥–µ–Ω—Ç —Å–±–æ—Ä–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Ç—Ä–∏–∫
‚îú‚îÄ‚îÄ server/      ‚Äî HTTP-—Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—ë–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è
‚îú‚îÄ‚îÄ keygen/      ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è HMAC-–∫–ª—é—á–µ–π
internal/
‚îú‚îÄ‚îÄ model/       ‚Äî –æ–±—â–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ handlers/    ‚Äî HTTP-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îú‚îÄ‚îÄ storage/     ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â
‚îú‚îÄ‚îÄ logger/      ‚Äî –ª–æ–≥–≥–µ—Ä –Ω–∞ zap
proto/           ‚Äî –ø—Ä–æ—Ç–æ–±—É—Ñ—ã –¥–ª—è gRPC (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
```

## üìå –ü–ª–∞–Ω—ã –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PostgreSQL –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
* –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ gRPC-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana
* –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

## üßë‚Äçüíª –ê–≤—Ç–æ—Ä

**–í–ª–∞–¥–∏–º–∏—Ä –ö—É—Ä–µ–ø–∏–Ω**
[GitHub](https://github.com/KurepinVladimir)
