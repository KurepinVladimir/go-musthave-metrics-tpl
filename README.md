# üìä Go Metrics Service

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–±–æ—Ä–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –Ω–∞ Go.  
–°–æ—Å—Ç–æ–∏—Ç –∏–∑ **–ê–≥–µ–Ω—Ç–∞** (—Å–±–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫) –∏ **–°–µ—Ä–≤–µ—Ä–∞** (–ø—Ä–∏—ë–º, —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –≤—ã–¥–∞—á–∞).

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –°–µ—Ä–≤–µ—Ä
- –ü—Ä–∏—ë–º –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —Ç–∏–ø–æ–≤: `gauge` –∏ `counter`.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã/—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - **JSON**
    - `POST /update` ‚Äî –æ–¥–Ω–∞ –º–µ—Ç—Ä–∏–∫–∞
    - `POST /updates` ‚Äî –±–∞—Ç—á –º–µ—Ç—Ä–∏–∫
    - `POST /value` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É –ø–æ JSON-–∑–∞–ø—Ä–æ—Å—É
  - **–¢–µ–∫—Å—Ç/URL**
    - `POST /update/{type}/{name}/{value}`
    - `GET /value/{type}/{name}`
- **–•—Ä–∞–Ω–∏–ª–∏—â–∞**:
  - **In-Memory** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - **–§–∞–π–ª–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** —Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å—å—é –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  - **PostgreSQL** (—á–µ—Ä–µ–∑ `DATABASE_DSN`; –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `migrations/`)
- **–°–∂–∞—Ç–∏–µ –∏ –ø–æ–¥–ø–∏—Å–∏**:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è **—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ gzip** (–µ—Å–ª–∏ `Content-Encoding: gzip`)
  - **Gzip-–æ—Ç–≤–µ—Ç** –ø—Ä–∏ `Accept-Encoding: gzip`
  - **HMAC-SHA256** –ø–æ–¥–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ `HashSHA256`) ‚Äî –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∫–ª—é—á–æ–º `KEY`
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** (zap), —Ä–æ—É—Ç–µ—Ä ‚Äî **chi**
- **–†–µ—Ç—Ä–∞–∏** —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–º. `internal/retry`)

### –ê–≥–µ–Ω—Ç
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫:
  - `runtime.MemStats` (Alloc, TotalAlloc, NumGC) –∏ `RandomValue`
  - **–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏** —á–µ—Ä–µ–∑ `gopsutil`:  
    `TotalMemory`, `FreeMemory`, `CPUutilization{N}` (–ø–æ —á–∏—Å–ª—É –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö CPU)
- –û—Ç–ø—Ä–∞–≤–∫–∞:
  - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä (`poll-interval`) –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (`report-interval`)
  - **Batched** –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ `/updates` (gzip + HMAC –ø–æ –∫–ª—é—á—É)
  - **HTTPS/HTTP** ‚Äî –∞–≥–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –ª—é–±–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞; TLS –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º/–ø—Ä–æ–∫—Å–µ–π
  - **–†–µ—Ç—Ä–∞–∏** —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π/—Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (—Å–º. `internal/retry`)
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**:  
  Worker-Pool —Å –≤–µ—Ä—Ö–Ω–∏–º –ª–∏–º–∏—Ç–æ–º –≤–æ—Ä–∫–µ—Ä–æ–≤ (**—Ñ–ª–∞–≥ `-l`**, –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `RATE_LIMIT`)
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ö–µ–¥–µ—Ä—ã:
  - `Content-Encoding: gzip` –¥–ª—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
  - `HashSHA256` –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º –∫–ª—é—á–µ (`KEY`)

## üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
cmd/
  agent/                # –∞–≥–µ–Ω—Ç: —Å–±–æ—Ä, –±–∞—Ç—á–∏–Ω–≥, –≤–æ—Ä–∫–µ—Ä—ã, —Ñ–ª–∞–≥–∏
    main.go
    flags.go
    batcher.go
    worker_pool.go
    collector_sys.go
  server/               # —Å–µ—Ä–≤–µ—Ä: —Ä–æ—É—Ç—ã, —Ñ–ª–∞–≥–∏, middleware
    main.go
    flags.go
    gzip_middleware.go
internal/
  cryptohelpers/        # HMAC: Sign / Compare
  handler/              # JSON-–æ—Ç–≤–µ—Ç —Å –ø–æ–¥–ø–∏—Å—å—é (WriteSignedJSONResponse), batch-handlers
  logger/               # zap + HTTP –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  middleware/           # ValidateHashSHA256 (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–∞)
  models/               # –º–æ–¥–µ–ª—å Metrics (gauge|counter)
  pgerrors/             # –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ PostgreSQL
  repository/           # Storage –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
                        #   - MemStorage (—Ñ–∞–π–ª/restore/periodic store)
                        #   - PostgresStorage (pgx, –º–∏–≥—Ä–∞—Ü–∏–∏)
  retry/                # retry helper —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
migrations/
  000001_init.up.sql    # gauge_metrics(name, value), counter_metrics(name, value)
  000001_init.down.sql
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
- **HMAC-SHA256**:
  - –ê–≥–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç ¬´—Å—ã—Ä—ã–µ¬ª –¥–∞–Ω–Ω—ã–µ **–¥–æ** —Å–∂–∞—Ç–∏—è; —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `HashSHA256`
  - –°–µ—Ä–≤–µ—Ä —Ç–∞–∫–∂–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç JSON-–æ—Ç–≤–µ—Ç—ã (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–∞)
- **Gzip**:
  - –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç gzip-—Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
  - –í—ã–¥–∞—ë—Ç gzip-–æ—Ç–≤–µ—Ç—ã, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—Å–ª–∞–ª `Accept-Encoding: gzip`

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –°–µ—Ä–≤–µ—Ä
–§–ª–∞–≥–∏ (–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è):
- `-a` / `ADDRESS` ‚Äî –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞–ø—Ä. `:8080` –∏–ª–∏ `0.0.0.0:8080`
- `-i` / `STORE_INTERVAL` ‚Äî –ø–µ—Ä–∏–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ –¥–∏—Å–∫ (—Å–µ–∫—É–Ω–¥—ã), `0` ‚Äî –∑–∞–ø–∏—Å—å –Ω–∞ –∫–∞–∂–¥—ã–π –∞–ø–¥–µ–π—Ç
- `-f` / `FILE_STORAGE_PATH` ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –Ω–∞–ø—Ä. `./storage.json`
- `-r` / `RESTORE` ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (`true|false`)
- `-d` / `DATABASE_DSN` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `-k` / `KEY` ‚Äî –∫–ª—é—á HMAC-SHA256 –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π

–ü—Ä–∏–º–µ—Ä—ã:
```bash
go run ./cmd/server   -a ":8080"   -i 300   -f "./storage.json"   -r true   -k "supersecret"

# –ß–µ—Ä–µ–∑ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
ADDRESS=:8080 STORE_INTERVAL=300 FILE_STORAGE_PATH=./storage.json RESTORE=true KEY=supersecret go run ./cmd/server
```

### –ê–≥–µ–Ω—Ç
–§–ª–∞–≥–∏ (–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è):
- `-a` / `ADDRESS` ‚Äî –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞–ø—Ä. `http://localhost:8080`
- `-p` / `POLL_INTERVAL` ‚Äî –ø–µ—Ä–∏–æ–¥ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ (—Å–µ–∫—É–Ω–¥—ã)
- `-r` / `REPORT_INTERVAL` ‚Äî –ø–µ—Ä–∏–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∞—Ç—á–∞ (—Å–µ–∫—É–Ω–¥—ã)
- `-k` / `KEY` ‚Äî –∫–ª—é—á HMAC-SHA256
- `-l` / `RATE_LIMIT` ‚Äî **–º–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (worker pool)

–ü—Ä–∏–º–µ—Ä—ã:
```bash
go run ./cmd/agent   -a "http://localhost:8080"   -p 2   -r 10   -l 4   -k "supersecret"

# –ß–µ—Ä–µ–∑ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
ADDRESS=http://localhost:8080 POLL_INTERVAL=2 REPORT_INTERVAL=10 RATE_LIMIT=4 KEY=supersecret go run ./cmd/agent
```

## üóÑÔ∏è PostgreSQL

### –ú–∏–≥—Ä–∞—Ü–∏–∏
```sql
CREATE TABLE IF NOT EXISTS gauge_metrics (
  name  TEXT PRIMARY KEY,
  value DOUBLE PRECISION NOT NULL
);

CREATE TABLE IF NOT EXISTS counter_metrics (
  name  TEXT PRIMARY KEY,
  value BIGINT NOT NULL
);
```

### –í–∫–ª—é—á–µ–Ω–∏–µ Postgres-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞
–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–¥–∞—Ç—å `DATABASE_DSN`, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```bash
DATABASE_DSN=postgres://user:pass@localhost:5432/metrics?sslmode=disable
```
–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ DSN —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `PostgresStorage`; –∏–Ω–∞—á–µ ‚Äî —Ñ–∞–π–ª–æ–≤–æ–µ –∏–ª–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `FILE_STORAGE_PATH`/`STORE_INTERVAL`/`RESTORE`).

## üß™ –¢–µ—Å—Ç—ã
- `cmd/agent/agent_test.go` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ gzip+JSON, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- `cmd/server/server_test.go` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏, –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `/update`, `/updates`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `testify/assert`

–ó–∞–ø—É—Å–∫:
```bash
go test ./...
```

## üì° –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### JSON: –æ–¥–Ω–∞ –º–µ—Ç—Ä–∏–∫–∞
```bash
curl -X POST http://localhost:8080/update   -H "Content-Type: application/json"   -d '{"id":"Alloc","type":"gauge","value":12345.67}'
```

### JSON: –±–∞—Ç—á –º–µ—Ç—Ä–∏–∫ (gzip)
```bash
printf '[{"id":"Alloc","type":"gauge","value":1.23},{"id":"PollCount","type":"counter","delta":5}]' | gzip | curl -X POST http://localhost:8080/updates     -H "Content-Type: application/json"     -H "Content-Encoding: gzip"     --data-binary @-
```

### –¢–µ–∫—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
```bash
curl -X POST http://localhost:8080/update/gauge/Alloc/123.45
curl "http://localhost:8080/value/gauge/Alloc"
```

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- Go, **chi** (HTTP), **zap** (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ), **resty** (–∫–ª–∏–µ–Ω—Ç)
- **gopsutil** (CPU/Mem)
- **pgx** (PostgreSQL), –º–∏–≥—Ä–∞—Ü–∏–∏ (SQL-—Ñ–∞–π–ª—ã)
- **testify/assert** (—Ç–µ—Å—Ç—ã)
- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ `cryptohelpers`, `retry`, `middleware`

## üó∫Ô∏è –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- gRPC / OpenAPI –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
- –≠–∫—Å–ø–æ—Ä—Ç/—Å–∫—Ä–µ–π–ø –¥–ª—è Prometheus, –¥–∞—à–±–æ—Ä–¥—ã Grafana
- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## üë§ –ê–≤—Ç–æ—Ä
**–í–ª–∞–¥–∏–º–∏—Ä –ö—É—Ä–µ–ø–∏–Ω** 
[GitHub](https://github.com/KurepinVladimir)
